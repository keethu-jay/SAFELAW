-- 1. Enable Vector Extension
create extension if not exists vector;

-- 2. CASES TABLE: The "Master" Record of each document
create table cases (
  id bigint primary key generated always as identity,
  citation text unique not null,      -- e.g. "[2025] UKSC 1"
  case_name text not null,            -- e.g. "El-Khouri v USA"
  court_level text not null,          -- "UKSC", "UKHL", "UpperTribunal_EAT"
  judgment_date date,
  judge_names text[],                 -- Array of judges: ["Lord Reed", "Lord Lloyd-Jones"]
  url text
);

-- 3. CHUNKS TABLE: The actual "Training Data" for conventions
create table chunks (
  id bigint primary key generated always as identity,
  case_id bigint references cases(id) on delete cascade,

  -- The core content users will see in the sidebar
  para_number int,                    -- e.g. 45
  content_text text not null,         -- The text of the paragraph

  -- RAG Filters (Critical for your tool's utility)
  author_name text,                   -- e.g. "Lord Leggatt" (or "Tribunal Panel")
  section_type text,                  -- "facts" (First ~15 paras) vs "analysis"
  opinion_type text,                  -- "majority", "concurring", "dissenting"

  -- Citation Logic (Simplified for RAG)
  has_citation boolean default false, -- Quick filter: "Show me paras with citations"
  cited_cases text[],                 -- Array of citations in this para: ["[1996] AC 1"]

  -- Voyage-3 Embedding
  embedding vector(1024)              -- Verify Voyage model dimension (1024 or 1536)
);

-- 4. CITATIONS TABLE (Optional: For "Related Cases" feature)
-- Use this ONLY if you want to show "Here are other cases that cite X"
create table citations_map (
  id bigint primary key generated always as identity,
  source_chunk_id bigint references chunks(id) on delete cascade,
  cited_citation_raw text             -- e.g. "[2008] AC 920"
);

-- 5. INDEXING (HNSW for speed)
create index on chunks using hnsw (embedding vector_cosine_ops);
create index on chunks (court_level); -- Fast filter for "Tribunal Only" searches